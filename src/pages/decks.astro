---
import Layout from "../layouts/Layout.astro";
import Navigation from "@/components/Navigation.astro";
import DeckListIsland from "../components/DeckListIsland.tsx";
import type { Deck } from "../types/deck";
import { lastModified } from "@/helpers/dateutils";

// Fetch initial decks for SSR
async function fetchDecks(): Promise<Deck[]> {
  try {
    const response = await fetch(
      "https://api.moxfield.com/v2/users/JohnnyCashMoney/decks"
    );
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();

    // Transform Moxfield API response to match our Deck type
    return data.data.map((deck: any) => ({
      id: deck.publicId,
      name: deck.name,
      format: deck.format
        ? deck.format.charAt(0).toUpperCase() + deck.format.slice(1)
        : "Commander",
      lastUpdatedAtUtc: deck.lastUpdatedAtUtc,
      description: lastModified(deck) || "",
      colors: deck.colors || [],
      image: deck.mainCardId
        ? `https://assets.moxfield.net/cards/card-${deck.mainCardId}-art_crop.webp`
        : undefined,
      link: `https://moxfield.com/decks/${deck.publicId}`,
    }));
  } catch (error) {
    console.error("Error fetching decks:", error);
    return [];
  }
}

const initialDecks = await fetchDecks();
---

<Layout title="Decklists">
  <Navigation />
  <div
    class="relative flex items-center justify-center overflow-hidden min-h-[calc(100vh-90px)]"
  >
    <main class="container mx-auto px-4 py-16">
      <h1
        class="text-4xl font-bold text-[var(--color-accent-primary)] mb-8 mt-8 text-center"
      >
        I play magic.
      </h1>
      <p
        class="mb-8 text-center text-xl sm:text-2xl text-[var(--color-text-secondary)] max-w-3xl mx-auto leading-relaxed"
      >
        I build my decks on <a
          href="https://moxfield.com/users/JohnnyCashMoney"
          class="text-[var(--color-accent-primary)]">Moxfield</a
        >. Here's the last few I've been working on.
      </p>

      <DeckListIsland client:load initialDecks={initialDecks} />
    </main>
  </div>
</Layout>
